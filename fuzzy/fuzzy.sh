if hadoop fs -test -e /user/oozie/sdhash/last; then echo last_sdhash_ok; else hdfs dfs -mkdir /user/oozie/sdhash/last; fi

if hadoop fs -test -e /user/oozie/ssdeep/last; then echo last_ssdeep_ok; else hdfs dfs -mkdir /user/oozie/ssdeep/last; fi

if hadoop fs -test -e /user/oozie/sdhash_scores; then echo sdhash_scores_ok; else hdfs dfs -mkdir /user/oozie/sdhash_scores; fi

if hadoop fs -test -e /user/oozie/ssdeep_scores; then echo ssdeep_scores_ok; else hdfs dfs -mkdir /user/oozie/ssdeep_scores; fi

if hadoop fs -test -e /user/oozie/sdhash/current; then hdfs dfs -rmr /user/oozie/sdhash/current; else echo sdhash_current_ok; fi

if hadoop fs -test -e /user/oozie/ssdeep/current; then hdfs dfs -rmr /user/oozie/ssdeep/current; else echo ssdeep_current_ok; fi


pig -stop_on_failure /opt/rb/var/rb-sequence-oozie/workflow/fuzzy/fuzzy.pig
if [ $? -ne 0 ]
then
  echo "Error at pig script."
  exit 1
fi

now=$(date +%s)
hdfs dfs -ls /user/oozie/fuzzy/ | grep "^d" | while read f; do

  dir_date=`echo $f | awk '{print $6,$7}'`

  difference=$((( $now - $(date -d "$dir_date" +%s) ) / (60*60)))
  if [ $difference -gt 0 ]; then
    to_remove=`echo $f | awk '{print $8}'`;
    hdfs dfs -rmr "$to_remove"
  fi
done
