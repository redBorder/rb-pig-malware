package net.redborder.malware.storages.kafka;

/**
 * Date: 12/3/15 17:39.
 */
import java.io.IOException;
import java.util.LinkedList;
import java.util.List;
import kafka.javaapi.producer.Producer;
import kafka.producer.KeyedMessage;
import org.apache.hadoop.mapreduce.RecordWriter;
import org.apache.hadoop.mapreduce.TaskAttemptContext;

public class KafkaRecordWriter<K,V> extends RecordWriter<K,V>
{
    protected Producer<Object, String> producer;
    protected String topic;

    protected List<KeyedMessage<Object, String>> msgList = new LinkedList<KeyedMessage<Object, String>>();

    public KafkaRecordWriter(Producer<Object, String> producer, String topic)
    {
        this.producer = producer;
        this.topic = topic;
    }

    protected void sendMsgList() throws IOException
    {
        if (msgList.size() > 0) {
            try {
                producer.send(msgList);
            }
            catch (Exception e) {
                throw new IOException(e);           // all Kafka exceptions become IOExceptions
            }
            msgList.clear();
        }
    }

    @Override
    public void write(K key, V value) throws IOException, InterruptedException
    {
        msgList.add(new KeyedMessage<Object, String>(this.topic, (String) value));
    }

    @Override
    public void close(TaskAttemptContext taskAttemptContext) throws IOException, InterruptedException
    {
        sendMsgList();
        producer.close();
    }
}
