package net.redborder.malware.storage;


import com.fasterxml.jackson.databind.ObjectMapper;
import net.redborder.malware.util.aerospike.AeroSpikeManager;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.io.compress.BZip2Codec;
import org.apache.hadoop.io.compress.GzipCodec;
import org.apache.hadoop.mapreduce.Job;
import org.apache.hadoop.mapreduce.OutputFormat;
import org.apache.hadoop.mapreduce.RecordWriter;
import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;
import org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;
import org.apache.pig.StoreFunc;
import org.apache.pig.data.DataBag;
import org.apache.pig.data.Tuple;

import java.io.IOException;
import java.util.*;

public class LoadersMergeStorage extends StoreFunc {
    RecordWriter writer = null;
    ObjectMapper objectMapper = new ObjectMapper();
    AeroSpikeManager aeroSpikeManager;
    String location;

    public LoadersMergeStorage(String location) {
        this.location = location;
    }

    @Override
    public OutputFormat getOutputFormat() throws IOException {
        return new TextOutputFormat<>();
    }

    @Override
    public void setStoreLocation(String location, Job job) throws IOException {
        job.getConfiguration().set("mapred.textoutputformat.separator", "");
        FileOutputFormat.setOutputPath(job, new Path(location));
        if (location.endsWith(".bz2")) {
            FileOutputFormat.setCompressOutput(job, true);
            FileOutputFormat.setOutputCompressorClass(job, BZip2Codec.class);
        }  else if (location.endsWith(".gz")) {
            FileOutputFormat.setCompressOutput(job, true);
            FileOutputFormat.setOutputCompressorClass(job, GzipCodec.class);
        }
    }

    @Override
    public void prepareToWrite(RecordWriter writer) throws IOException {
        this.writer = writer;
        this.aeroSpikeManager = AeroSpikeManager.getInstance();

    }

    @Override
    public void putNext(Tuple tuple) throws IOException {
        System.out.println("TUPLE TYPE:"+tuple.getType(0));
        System.out.println("TUPLE: "+tuple.get(0));
        String sha256 = (String) tuple.get(0);
        List<Map<String, Object>> list = new ArrayList<>();

        Object t = tuple.get(1);

        if(t instanceof String){
            Map<String, Object> map = objectMapper.readValue((String) t, Map.class);
            list.add(map);
        } else {
            Iterator<Tuple> tupleIter = ((DataBag) t).iterator();

            while (tupleIter.hasNext()) {
                String str = (String) tupleIter.next().get(0);
                Map<String, Object> map = objectMapper.readValue(str, Map.class);
                list.add(map);
            }
        }

        Map<String, Object> result = new HashMap<>();
        result.put("sha256", sha256);
        result.put("data", list);

        String jsonResult = objectMapper.writeValueAsString(result);
        Text text = new Text(jsonResult.getBytes());

        try {
            writer.write(null, text);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        aeroSpikeManager.updateDataLocation(sha256, location);
    }
}
