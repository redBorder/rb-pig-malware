package net.redborder.malware.loaders.cuckoo;

import net.redborder.malware.loaders.AbstractFileDroppingLoader;
import net.redborder.malware.util.MultipartUtility;
import net.redborder.malware.util.aerospike.AeroSpikeManager;
import net.redborder.malware.util.logger.RbLogger;
import org.apache.hadoop.io.BytesWritable;
import org.apache.hadoop.io.Text;
import org.apache.pig.data.Tuple;
import org.codehaus.jackson.map.ObjectMapper;

import java.io.File;
import java.io.IOException;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.nio.file.Files;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.logging.Logger;


public class CuckooLoader extends AbstractFileDroppingLoader {

    String CuckooToConnect = " http://127.0.0.1:8090/tasks/create/file";
    String urlToConnect;
    ObjectMapper mapper;
    Integer MAX_RETRIES = 5;
    Logger log;
    String[] cuckoo_filters;
    String scoreName = "sb_cuckoo";

    public CuckooLoader(String url, String filters, String zkHost, String timeout, String useDevShm) {
        this(url, filters, zkHost, "5", timeout, useDevShm);
    }

    public CuckooLoader(String url, String filters, String zkHost, String maxRetries, String timeout, String useDevShm) {
        super(zkHost, timeout, useDevShm);
        MAX_RETRIES = Integer.valueOf(maxRetries);
        mapper = new ObjectMapper();
        log = RbLogger.getLogger(CuckooLoader.class.getName());
        cuckoo_filters = filters.replace(" ", "").split(",");
        CuckooToConnect = url;
        ObjectMapper mapper;
    }

    @Override
    public Tuple processFile(Text key, BytesWritable value, File binaryFile) throws IOException {

        List<String> response;
        String fileType = Files.probeContentType(binaryFile.toPath());
        boolean shaFilter = false;

        for (String filter : cuckoo_filters) {
            if (!filter.equals("") && !filter.equals("none")) {
                System.out.println("Filter: " + filter);
                if (fileType != null && fileType.contains(filter)) {
                    shaFilter = true;
                }
            }
        }

        if (!isCuckooBefore(key.toString()) && !shaFilter) {
            System.out.println("Analyzing: " + key);
            urlToConnect = "http://" + CuckooToConnect + ":8090/tasks/create/file";

            boolean next = true;
            int times = 0;
            StringBuffer result = new StringBuffer();
            while (next && times < 5) {
                try {
                    MultipartUtility multipart = new MultipartUtility(urlToConnect, "UTF-8");

                    multipart.addHeaderField("User-Agent", "CodeJava");
                    multipart.addHeaderField("Test-Header", "Header-Value");

                    multipart.addFilePart("file", binaryFile);
                    response = multipart.finish();

                    for (String line : response) {
                        result.append(line);
                    }
                    next = false;
                } catch (IOException ex) {
                    times++;
                    System.out.println("Retry #" + times);
                    ex.printStackTrace();
                }
            }

            Map<String, Object> data = new HashMap<>();

            if (times < 5) {
                String json = result.toString();
                Map<String, Object> status = (Map<String, Object>) mapper.readValue(json, Map.class);

                String id = String.valueOf(status.get("task_id"));

                if (id != null) {
                    data.put("task_id", status.get("task_id"));
                    data.put("score", -1);
                    data.put("timestamp", System.currentTimeMillis() / 1000);
                    data.put("type", "cuckoo");

                    Map<String, Object> toCache = new HashMap<>();
                    toCache.put("cuckoo_before", 1);
                    toCache.putAll(data);


                    updateMalwareScore(key.toString(), scoreName, 0L, LoaderType.SLOW);
                } else {
                    System.out.println(status);
                }
            } else {
                data.put("score", -1);
                data.put("timestamp", System.currentTimeMillis() / 1000);
                data.put("type", "cuckoo");
                data.put("message", "Max retries limit reached #" + times + " url [" + urlToConnect + "]");
                System.out.println("Max retries limit reached #" + times + " url [" + urlToConnect + "]");
            }

            try {
                String hostname = InetAddress.getLocalHost().getHostName();
                data.put("sensor_name", hostname);
            } catch (UnknownHostException e) {
                e.printStackTrace();
            }

            String data_string = mapper.writeValueAsString(data);

            getProtoTuple().clear();
            getProtoTuple().add(key.toString());
            getProtoTuple().add(data_string);
        } else {
            getProtoTuple().clear();
        }
        return getTupleFactory().newTuple(getProtoTuple());
    }

    public boolean isCuckooBefore(String sha256) {
        boolean before = true;
        AeroSpikeManager aerospike = AeroSpikeManager.getInstance();
        Map<String, Object> sha_info = aerospike.getHash(sha256);
        if (sha_info.get("sb_cuckoo") == null || (Integer) sha_info.get("sb_cuckoo") == -1) {
            before = false;
        }
        return before;
    }

}
