package net.redborder.malware.loaders.sdhash;

/**
 * Created by Lito on 26/6/15.
 */

/**
 * This work is made available under the Apache License, Version 2.0.
 *
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */


import com.aerospike.client.Record;
import com.amazonaws.util.json.JSONArray;
import com.amazonaws.util.json.JSONException;
import com.fasterxml.jackson.databind.ObjectMapper;
import net.redborder.malware.util.aerospike.AeroSpikeManager;
import net.redborder.malware.util.gridgain.GridGainManager;
import net.redborder.malware.util.kafka.KafkaManager;
import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.*;
import org.apache.pig.EvalFunc;
import org.apache.pig.data.Tuple;
import org.apache.pig.data.TupleFactory;
import org.gridgain.grid.GridException;

import java.io.*;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;


public class Sdhash extends EvalFunc<Map> {

    String SHA256;
    String sdhash;
    String hdfs;
    Map<String, Object> map;
    Map<String, Object> relations;
    Integer score_compared;
    Integer score_torefresh;
    String malware_name_compared;
    ObjectMapper mapper;
    String zkHosts;


    public Map exec(Tuple input) throws IOException {
        TupleFactory tupleFactory = TupleFactory.getInstance();
        ArrayList<Object> protoTuple = new ArrayList<>();

        map = new HashMap<>();
        relations = new HashMap<>();
        SHA256 = (String) input.get(0);
        sdhash = (String) input.get(1);
        hdfs = (String) input.get(2);
        zkHosts = (String) input.get(3);
        map.put("sha256", SHA256);
        map.put("sdhash", sdhash);

        StringBuilder scores = new StringBuilder();
        File file = new File("/tmp/fuzzy/sdhash-file.sdbf");
        File file2 = new File("/tmp/fuzzy/sdhash-file2.sdbf");


        File parent = file.getParentFile();

        if (!parent.exists() && !parent.mkdirs()) {
            throw new IllegalStateException("Couldn't create dir: " + parent);
        }
        File parent2 = file2.getParentFile();
        if (!parent2.exists() && !parent2.mkdirs()) {
            throw new IllegalStateException("Couldn't create dir: " + parent2);
        }

        try {
            FileWriter f2 = new FileWriter(file, false);
            f2.write(sdhash);
            f2.close();

        } catch (IOException e) {
            e.printStackTrace();
        }

        Path pt = new Path("hdfs://" + hdfs + ":8020/user/oozie/sdhash/current/part-r-00000");
        FileSystem fs = FileSystem.get(new Configuration());
        BufferedReader br = new BufferedReader(new InputStreamReader(fs.open(pt)));
        try {
            String line;
            line = br.readLine();
            while (line != null) {
                String compared_sha = line.split(",")[0];
                try {
                    FileWriter fwriter = new FileWriter(file2, false);
                    fwriter.write(line.split(",")[1]);
                    fwriter.close();

                } catch (IOException e) {
                    e.printStackTrace();
                }

                String[] cmd = new String[]{
                        "sdhash",
                        "-c",
                        file.getAbsolutePath(),
                        file2.getAbsolutePath(), "-t", "0"
                };

                ProcessBuilder processBuilder = new ProcessBuilder(cmd);
                processBuilder.redirectErrorStream(true);
                Process process = processBuilder.start();
                BufferedReader result = new BufferedReader(new InputStreamReader(process.getInputStream()));
                scores = new StringBuilder();
                while ((line = result.readLine()) != null) {
                    scores.append(line);
                    String score = line.toString().split("\\|")[2];
                    if (Integer.parseInt(score) > 98) {
                        relations.put(compared_sha, score);

                        // try {

                        if (!compared_sha.equals(SHA256)) {

                            // Map<String, Object> malware = (Map<String, Object>) GridGainManager.getInstance().getMalwareCache().get(SHA256); // GG
                            Record malware = AeroSpikeManager.getInstance().get("malware", "rb_malware", SHA256);
                            if (malware != null) {
                                score_torefresh = (Integer) malware.getInt("score");
                            } else {
                                score_torefresh = 0;
                            }
                            if (score_torefresh < 80) {
                                // Map<String, Object> malware2 = (Map<String, Object>) GridGainManager.getInstance().getMalwareCache().get(compared_sha); // GRIDGAIN
                                Record malware2 = AeroSpikeManager.getInstance().get("malware", "rb_malware", compared_sha);

                                if (malware2 != null) {
                                    score_compared = (Integer) malware2.getInt("score");
                                    malware_name_compared = (String) malware2.getString("malware_name");
                                    if(malware_name_compared == null){
                                        malware_name_compared = "unknown";
                                    }

                                    if (!malware_name_compared.equals("clean")){
                                        malware_name_compared=malware_name_compared+"-fuzzy";
                                    }

                                } else {
                                    score_compared = 0;
                                }
                                if (score_compared > 95) {
                                    Map<String, Object> data = new HashMap<>();

                                    String hostname = "";

                                    try {
                                        hostname = InetAddress.getLocalHost().getHostName();
                                    } catch (UnknownHostException e) {
                                        e.printStackTrace();
                                    }
                                    data.put("sha256", SHA256);
                                    data.put("cuckoo_before", isCuckooBefore(SHA256));
                                    data.put("timestamp", System.currentTimeMillis() / 1000);
                                    data.put("type", "sdhash");
                                    data.put("sensor_name", hostname);
                                    data.put("score", 80);
                                    data.put("malware_name", malware_name_compared);
                                    System.out.println("Sending kafka msg");
                                    System.out.println(data);
                                    mapper = new ObjectMapper();
                                    String send = mapper.writeValueAsString(data);
                                    KafkaManager.getInstance(zkHosts).send("rb_malware", send);
                                    List<String> columns = new ArrayList<>();
                                    List<Object> values = new ArrayList<>();

                                    columns.add("sha256");
                                    columns.add("score");
                                    columns.add("cuckoo_before");
                                    columns.add("malware_name");
                                    values.add(data.get("sha256"));
                                    values.add(data.get("score"));
                                    values.add(data.get("cuckoo_before"));
                                    values.add(data.get("malware_name"));

                                    AeroSpikeManager.getInstance().put("malware","rb_malware",SHA256,columns,values);
                                    //GridGainManager.getInstance().getMalwareCache().put(SHA256, data);

                                }


                            }
                        }
                        //   } catch (GridException e) {
                        //       e.printStackTrace();
                        //   }
                    }


                }


                line = br.readLine();
            }
            map.put("similarity", relations);
            JSONArray jsonArray = new JSONArray();
            jsonArray.put(map);
            try {
                protoTuple.add(jsonArray.getString(0));
            } catch (JSONException e) {
                e.printStackTrace();
            }

        } finally {
            br.close();
        }

        map.put("timestamp", System.currentTimeMillis() / 1000);
        return map;
    }


    public boolean isCuckooBefore(String md5) {
        Boolean before = false;
/*        try {
            Map<String, Object> malware = GridGainManager.getInstance().getMalwareCache().get(md5);
            if (malware != null) {
                before = (Boolean) malware.get("cuckoo_before");
                if (before == null) {
                    before = false;
                }
            }
        } catch (GridException e) {
            e.printStackTrace();
        }*/
        Record malware = AeroSpikeManager.getInstance().get("malware", "rb_malware", md5);
        if (malware != null) {
            before =  malware.getBoolean("cuckoo_before");
            if (before == null) {
                before = false;
            }
        }

        return before;
    }


}

